name: build-and-test

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ "**" ]

jobs:
  build_and_test:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute Vars
        id: vars
        run: |
          echo "image_tag=${{ github.repository }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build image
        run: |
          docker build -t ${{ steps.vars.outputs.image_tag }} .

      - name: Run tests
        run: |
          set -ex

          # docker run command with flags
          DOCKER_RUN=docker run --rm --gpus=all --shm-size=24G \
              -v ${{ github.workspace }}/tests:/workspace/cosmos-rl/tests \
              -w /workspace/cosmos-rl \
              ${{ steps.vars.outputs.image_tag }}

          ${DOCKER_RUN} python tests/test_cache.py
          # ${DOCKER_RUN} torchrun --nproc_per_node=4 tests/test_comm.py
          ${DOCKER_RUN} python tests/test_fp8.py
          # ${DOCKER_RUN} python tests/test_grad_allreduce.py
          # ${DOCKER_RUN} python tests/test_high_availability_nccl.py
          ${DOCKER_RUN} python tests/test_nccl_collectives.py
          # ${DOCKER_RUN} python tests/test_nccl_timeout.py
          ${DOCKER_RUN} python tests/test_parallel_map.py
          ${DOCKER_RUN} python tests/test_policy_to_policy.py
          ${DOCKER_RUN} python tests/test_policy_to_rollout.py
          ${DOCKER_RUN} python tests/test_process_flow.py

      - name: Cleanup
        if: always()
        run: |
          set -ex
          docker stop $(docker ps -a -q) || true
          docker rmi -f "${{ steps.vars.outputs.image_tag }}" || true
          sudo git clean -xffd || true
