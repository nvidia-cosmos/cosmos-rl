name: build-and-test

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ "**" ]

jobs:
  build_and_test:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute Vars
        id: vars
        run: |
          echo "image_tag=${{ github.repository }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build image
        run: |
          docker build -t ${{ steps.vars.outputs.image_tag }} .

      - name: Run tests
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.vars.outputs.image_tag }}
          options: |
            --gpus all
            --shm-size=24G
            -v ${{ github.workspace }}/tests:/workspace/cosmos-rl/tests
            -w /workspace/cosmos-rl
          shell: /bin/bash
          run: |
            set -ex

            # run tests
            python tests/test_cache.py
            # torchrun --nproc_per_node=4 tests/test_comm.py
            python tests/test_fp8.py
            # python tests/test_grad_allreduce.py
            # python tests/test_high_availability_nccl.py
            python tests/test_nccl_collectives.py
            # python tests/test_nccl_timeout.py
            python tests/test_parallel_map.py
            python tests/test_policy_to_policy.py
            python tests/test_policy_to_rollout.py
            python tests/test_process_flow.py

      - name: Cleanup
        if: always()
        run: |
          set -ex

          docker stop $(docker ps -a -q) || true
          docker rmi -f "${{ steps.vars.outputs.image_tag }}" || true
          git clean -xffd || true
