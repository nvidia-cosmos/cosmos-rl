name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ "**" ]

jobs:
  build-image:
    uses: ./.github/workflows/build_image.yml
    with:
      runs-on: ubuntu-latest
      tag: ${{ github.sha }}
    secrets: inherit 

  test:
    runs-on: ubuntu-latest
    needs: build-image
    steps:     
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "leptonai>=0.25.5"
          lep login -c ${{ secrets.LEPTONAI_WORKSPACE_ID }}:${{ secrets.LEPTONAI_API_KEY }}
      
      - name: Run tests
        run: |
          # Add your test commands here
          lep job create --name "test_nccl_timeout" --container-image ghcr.io/nvidia-cosmos/${{ github.repository }}/${{ github.sha }} --resource-shape "gpu.4xh100-sxm" --num-workers 1 --command "python tests/test_nccl_timeout.py"

